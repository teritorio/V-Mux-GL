vt_merge_proxy_server

# Build
```
docker-compose -f docker-compose.yaml -f docker-compose-tools.yaml build
```

# Configuration

`config.yaml`

```yaml
sources:
    foo:
        key: fi787or6ej8famrejfffp
        polygon: dax.geojson

        sources:
            full:
                tilejson_url: https://vecto-dev.teritorio.xyz/data/teritorio-dev.json
                tile_url: http://localhost:3000
            partial:
                mbtiles: restaurent-20200819.mbtiles

        merge_layers:
            poi_tourism:
                fields: [superclass, class, subclass]
                classes: classes.json
            features_tourism:

        output:
            min_zoom: 14

        styles:
            teritorio-tourism-0.9:
                url: https://vecto.teritorio.xyz/styles/teritorio-tourism-0.9/style.json
                merged_source: openmaptiles
                # Patch the style
                layers_patch:
                    # Patch from local diff file
                -   diff:
                        patch: /data/features.layers-patch.json
                    amend:
                        add:
                        -   id: features-fill
                            insert_before_id: building
                    # Diff3, patch generated by diff on other styles
                -   diff:
                        from: https://vecto.teritorio.xyz/styles/teritorio-basic-dev/style.json
                        to: https://vecto.teritorio.xyz/styles/teritorio-tourism-dev/style.json
                # Add layers
                layers:
                -   insert_before_id: building
                    layer: &features-outline
                        id: features-outline
                        type: line
                        source: openmaptiles
                        source-layer: features
                        paint:
                            line-color: #ff0000

server:
    public_base_path:
    public_tile_url_prefixes: []
```


# Initialize data
Setup configuration in `data` and fetch data:
```
docker-compose -f docker-compose.yaml -f docker-compose-tools.yaml run --rm fetcher
```

# Run
```
docker-compose up -d
```

Fill the tiles cache in nginx:
```
docker-compose -f docker-compose.yaml -f docker-compose-tools.yaml run --rm expire
```


# Data update

Get and switch to new data:
```
docker-compose -f docker-compose.yaml -f docker-compose-tools.yaml run --rm fetcher
docker-compose restart
```

Partial fetch
```
docker-compose -f docker-compose.yaml -f docker-compose-tools.yaml run --rm fetcher bash -c 'ruby ./update.rb foo'
```

Update the tiles cache in nginx:
```
docker-compose -f docker-compose.yaml -f docker-compose-tools.yaml run --rm expire
```

Partial expire
```
docker-compose -f docker-compose.yaml -f docker-compose-tools.yaml run --rm expire sh -c 'ruby ./get_tiles.rb foo'
```


# Serve

Under reverse proxy HTTP header `Host` should contains the original value.
Header `Forwarded` should also properly set. See https://www.nginx.com/resources/wiki/start/topics/examples/forwarded/
